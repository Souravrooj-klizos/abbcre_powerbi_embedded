# Power BI Embedded Portal — AB&BCRE

Integration of **Power BI Embedded** into AB&BCRE’s web application (abbcre.com) using the **App Owns Data** model. Built with **Next.js**, **PostgreSQL**, and **Azure AD (Service Principal)**.

---

## 1. Executive Summary

- **Client:** AB&BCRE  
- **Provider:** Klizo Solutions Pvt. Ltd.  
- **Stack:** Next.js (React), Node.js API routes, PostgreSQL, Power BI Embedded (App Owns Data), Azure AD Service Principal. **SDK:** `powerbi-client` + `powerbi-client-react` (Power BI Embedded SDK only; no Fabric SDK).  
- **Goal:** Backend + frontend to authenticate with Azure, generate embed tokens, map users to reports/roles in PostgreSQL, and render the correct Power BI report per logged-in user.

---

## 2. Concepts (Quick Reference for Next.js Devs)

### 2.1 Power BI Embedded — “App Owns Data”

- Your **Next.js app** (the “app”) owns the data access.
- End users do **not** need Power BI accounts or licenses.
- Flow: user logs into your site → your API gets an **embed token** from Power BI → frontend shows the report in an iframe.

### 2.2 Azure AD & Service Principal

- **Azure AD (Entra ID):** Microsoft’s identity provider. We use it to prove our app is allowed to call Power BI.
- **App Registration:** Represents your app in Azure (Client ID, Tenant ID, Client Secret).
- **Service Principal:** The “robot account” for your app. Power BI trusts this identity to generate embed tokens.
- **Env vars you’ll use:** `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `AZURE_TENANT_ID` (see `.env.example`).

### 2.3 Tokens

- **Azure AD (access) token:** Used by your **backend** to call Power BI REST APIs. Short-lived (~1 hour).
- **Embed token:** Generated by your backend via Power BI API; passed to the **frontend** so the Power BI JavaScript SDK can load the report. Never expose Client ID/Secret to the browser.

### 2.4 Row-Level Security (RLS)

- RLS in Power BI restricts which **rows** of data a user sees (e.g. by region, role).
- Your app will pass **roles** (and optionally effective identity) when requesting the embed token so Power BI applies the right filters.
- Defining the actual DAX/roles in the .pbix is the **client/analyst** responsibility; we provide the technical structure (e.g. role names and how they’re stored in PostgreSQL).

### 2.5 PostgreSQL in This Project

- **Use:** Store **user → report** and **user → security role** mapping (lookup tables).
- **Why PostgreSQL:** Client requirement; good fit for relational mapping (user id, report id, role name, workspace id).
- **If you’re from NoSQL:** Think of tables like collections, with strict columns and relations. Use **connection pooling** (e.g. `pg.Pool`) in Next.js API routes; do **not** open a new connection per request. Use migrations (e.g. Prisma, Drizzle, or raw SQL) for schema changes.

---

## 3. Scope of Work (Phases)

| Phase | Description | Duration |
|-------|-------------|----------|
| **1** | Azure AD App Registration, Service Principal, Power BI “Embedded” workspace, tenant settings, secure storage of API credentials. | 1 week |
| **2** | Next.js backend: Auth with Azure AD, embed token API, PostgreSQL lookup (user ↔ report ID, workspace ID, security roles). | 4 weeks (with Phase 3) |
| **3** | Next.js frontend: Power BI Embedded SDK (`powerbi-client-react`) embed, dynamic report by user, UI/layout for report container. | 4 weeks (with Phase 2) |
| **4** | RLS structure definition, end-to-end testing with a placeholder report, UAT, deployment. | 1 week |

**Out of scope:** Creating or editing Power BI .pbix reports, data models, or visuals.

---

## 4. Technical Architecture

| Layer | Technology |
|-------|------------|
| Frontend | Next.js (React) |
| Backend | Next.js API Routes (Node.js) |
| Database | PostgreSQL |
| Embedding | Power BI Embedded — App Owns Data |
| Auth (to Power BI) | Azure AD Service Principal |
| Embed component | `powerbi-client-react` |

---

## 5. Repository Structure

```
powerbi-embedded-portal/
├── docs/                 # All documentation (see docs/README.md)
│   ├── TODO.md           # SOW checklist, build tracker
│   ├── DESIGN-REFERENCE.md
│   └── PROJECT-STRUCTURE.md
├── public/               # Static assets; .gitkeep keeps folder in Git when empty
├── .env                  # Your secrets (gitignored). Copy from .env.example. Next.js + Prisma read this.
├── .env.example          # Env template.
├── README.md             # This file
├── package.json
├── tsconfig.json
├── next.config.ts
├── tailwind.config.ts
├── postcss.config.mjs
├── src/
│   ├── app/              # Next.js App Router
│   │   ├── api/          # API routes (e.g. api/health, api/embed-token later)
│   │   │   └── health/
│   │   ├── globals.css
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   └── not-found.tsx
│   ├── components/
│   │   └── ui/           # Reusable UI; add ReportEmbed here later
│   ├── lib/
│   │   ├── db/           # PostgreSQL pool and queries
│   │   ├── powerbi/      # Power BI API client, embed token
│   │   ├── auth/         # Session / user context for report mapping
│   │   └── utils.ts      # e.g. cn() for class names
│   ├── types/            # Shared TypeScript types
│   └── hooks/            # Custom React hooks
└── public/               # Static assets (add favicon etc. as needed)
```

---

## 6. Environment Variables

Copy `.env.example` to `.env` and fill in values. See `.env.example` for comments. Next.js and Prisma both read `.env`.

- **Azure:** `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `AZURE_TENANT_ID`  
- **Power BI:** `POWERBI_WORKSPACE_ID`, and optionally default report IDs for dev.  
- **Database:** `DATABASE_URL` (PostgreSQL connection string).  
- **App:** `NEXTAUTH_SECRET` (or equivalent) if you use NextAuth/session-based auth.

---

## 6.1 How to Get Azure Credentials (AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID)

**Note:** [My Applications](https://myapplications.microsoft.com/) only shows apps you can sign in to. It does **not** create or list **App Registrations** used for API credentials. You must use the **Azure Portal** (or Microsoft Entra admin center) to create an App Registration and get these values.

### Step 1 — Open Azure Portal and go to App registrations

1. Go to **[Azure Portal](https://portal.azure.com)** and sign in with the account your CEO gave you (same org as your Azure subscription).
2. In the search bar at the top, type **“Microsoft Entra ID”** (or **“Azure Active Directory”**) and open it.
3. In the left menu, click **App registrations**.
4. Click **+ New registration**.

### Step 2 — Register the application

1. **Name:** e.g. `ABBCRE Power BI Embedded` (any name you like).
2. **Supported account types:** Choose **“Accounts in this organizational directory only”** (single tenant) unless you have a multi-tenant requirement.
3. **Redirect URI:** You can leave it blank for now (this app uses client credentials, not user sign-in).
4. Click **Register**.

### Step 3 — Copy Application (client) ID and Directory (tenant) ID

On the app’s **Overview** page you’ll see:

- **Application (client) ID** → use as `AZURE_CLIENT_ID`
- **Directory (tenant) ID** → use as `AZURE_TENANT_ID`

Copy both into your `.env`.

### Step 4 — Create a client secret

1. In the left menu of the App Registration, click **Certificates & secrets**.
2. Under **Client secrets**, click **+ New client secret**.
3. **Description:** e.g. `Power BI Embedded portal`.
4. **Expires:** Choose a duration (e.g. 24 months). You’ll need to create a new secret before it expires and update `.env`.
5. Click **Add**.
6. **Copy the secret Value immediately** — it’s shown only once. If you leave the page without copying, you must create a new secret.
7. Use this value as `AZURE_CLIENT_SECRET` in `.env`.

**Security:** Never commit the secret to git or expose it in the frontend. Use it only in server-side code (Next.js API routes) and in `.env` (which is in `.gitignore`).

### Step 5 — Allow the app to use Power BI (later in Phase 1)

For the app to call Power BI APIs, your admin will need to:

- Add the Service Principal to the Power BI **Embedded** workspace as **Admin**.
- Enable **tenant settings** in Power BI to allow the Service Principal to use the Power BI API.

The App Registration alone gives you the three env vars; Power BI access is configured separately in the Power BI service.

**References:** [Register an application in Microsoft Entra ID](https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-register-app), [Add client secret](https://learn.microsoft.com/en-us/entra/identity-platform/how-to-add-credentials).

---

## 6.1a How to Get POWERBI_WORKSPACE_ID

The **Workspace ID** (also called **Group ID**) comes from **Power BI Service** ([app.powerbi.com](https://app.powerbi.com)), not from Azure Portal. You need a Power BI account (Pro license or the workspace shared with you) and a workspace where reports are published.

### Step 1 — Open Power BI Service

1. Go to **[https://app.powerbi.com](https://app.powerbi.com)** and sign in with your work account (same org as your Azure tenant).
2. If you don’t have access, your admin must assign you a Power BI Pro license or add you to the workspace (per SOW, client provides this).

### Step 2 — Create or open a workspace

- **Create:** Left rail → **Workspaces** → **+ New workspace** → name it (e.g. **Embedded** for the dedicated embed workspace from the SOW) → **Save**.
- **Or** open an existing workspace where the reports live.

### Step 3 — Get the Workspace ID from the URL

1. Click the workspace so you’re **inside** it (you see reports/dashboards).
2. Look at the browser address bar. The URL looks like:
   ```text
   https://app.powerbi.com/groups/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/...
   ```
3. The GUID after **`/groups/`** is the **Workspace ID**. Copy it.
4. Put it in `.env`:
   ```bash
   POWERBI_WORKSPACE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   ```

### If you don’t see Workspaces or the URL

- You may need a **Power BI Pro** license or to be added to the workspace by an admin.
- The client (or your CEO) may need to create the dedicated **Embedded** workspace and add your App’s **Service Principal** as **Admin** (Phase 1). Once that’s done, you can get the workspace ID from the URL when they share the workspace or from the Power BI REST API (e.g. “Get Groups”) using your Azure credentials.

**Reference:** [Power BI workspaces](https://learn.microsoft.com/en-us/power-bi/collaborate-share/service-create-the-new-workspaces)

---

## 6.2 How to Get Database Credentials (PostgreSQL)

You need a running PostgreSQL instance and a **connection string** for `.env`:

```bash
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DATABASE
```

Choose one of the options below.

### Option A — Neon (recommended for MVP, ~500 MB free)

Good if you don’t want to install PostgreSQL locally. Sign up at [neon.tech](https://neon.tech) (e.g. with GitHub).

1. **Create a project**
   - After sign-in, click **New Project**.
   - **Name:** e.g. `abbcre-powerbi` or `abbcre-mvp`.
   - **Region:** Pick one close to you (e.g. US East, EU).
   - **PostgreSQL version:** 16 or 17 is fine.
   - Click **Create project**.

2. **Get the connection string**
   - On the project **Dashboard**, you’ll see a **Connection string** section.
   - Choose **Pooled connection** (recommended for serverless/Next.js) or **Direct connection**.
   - Copy the URI (it looks like `postgresql://user:password@ep-xxx-xxx.region.aws.neon.tech/neondb?sslmode=require`).
   - If you see a **Password** field that’s blurred, you may need to **Reset password** once and then copy the new connection string (it includes the password).

3. **Optional: create a dedicated database**
   - In the left sidebar, open **SQL Editor**.
   - Run: `CREATE DATABASE abbcre_powerbi;`
   - Then in the connection string, replace the default database name (e.g. `neondb`) with `abbcre_powerbi`. Or keep the default database; both work.

4. **Put it in `.env`**
   ```bash
   DATABASE_URL=postgresql://user:password@ep-xxx.region.aws.neon.tech/neondb?sslmode=require
   ```
   Paste your actual string. If the password has special characters (`@`, `#`, `%`, etc.), **URL-encode** them (e.g. `@` → `%40`).

5. **Free tier**
   - Neon’s free tier (e.g. 500 MB storage) is enough for MVP. You can upgrade later if needed.

---

### Option B — Local PostgreSQL (already installed)

1. **Install PostgreSQL** (if not installed):
   - **Windows:** [PostgreSQL installer](https://www.postgresql.org/download/windows/) — during setup, note the password you set for the `postgres` user and the port (default `5432`).
   - **macOS:** `brew install postgresql@16` then `brew services start postgresql@16`.
   - **Linux:** `sudo apt install postgresql postgresql-contrib` (or equivalent).

2. **Create a database and (optional) user:**
   - Open a shell and connect: `psql -U postgres` (or use pgAdmin).
   - Run:
     ```sql
     CREATE DATABASE abbcre_powerbi;
     -- Optional: create a dedicated user
     CREATE USER abbcre_app WITH PASSWORD 'your_secure_password';
     GRANT ALL PRIVILEGES ON DATABASE abbcre_powerbi TO abbcre_app;
     ```

3. **Set in `.env`:**
   ```bash
   # Using default postgres user
   DATABASE_URL=postgresql://postgres:YOUR_POSTGRES_PASSWORD@localhost:5432/abbcre_powerbi

   # Or using the dedicated user
   DATABASE_URL=postgresql://abbcre_app:your_secure_password@localhost:5432/abbcre_powerbi
   ```

### Option C — Docker (no local PostgreSQL install)

1. **Run PostgreSQL in a container:**
   ```bash
   docker run -d --name abbcre-pg -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=abbcre_powerbi -p 5432:5432 postgres:16
   ```

2. **Set in `.env`:**
   ```bash
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/abbcre_powerbi
   ```

To stop: `docker stop abbcre-pg`. To start again: `docker start abbcre-pg`.

### Option D — Other cloud (Supabase, Azure, Railway)

You get the connection string from the provider’s dashboard after creating a project/database.

| Provider | Where to get credentials |
|----------|---------------------------|
| **[Supabase](https://supabase.com)** | New project → **Settings → Database** → “Connection string” (URI format). Use the **Transaction** or **Session** pooler URL if shown. |
| **[Azure Database for PostgreSQL](https://azure.microsoft.com/en-us/products/postgresql)** | Server → **Connection strings** in Azure Portal; format: `postgresql://USER@SERVER:PASSWORD@SERVER.postgres.database.azure.com:5432/DATABASE?sslmode=require`. |
| **[Railway](https://railway.app)** | New project → Add PostgreSQL → **Variables** tab shows `DATABASE_URL`. |

**Important:** If the URL contains special characters in the password, **URL-encode** them (e.g. `@` → `%40`, `#` → `%23`).

### Local vs production (AWS / Vercel)

- **Local:** `DATABASE_URL` with `localhost` is correct — your app and PostgreSQL both run on your machine.
- **Production (AWS, Vercel, etc.):** The same local string **will not work**. On the server, `localhost` means that server, not your PC, and your PC is not reachable from the internet.
- **What to do for production:** Use a **hosted** PostgreSQL (e.g. AWS RDS, [Neon](https://neon.tech), [Supabase](https://supabase.com), Vercel Postgres). Create a database there, get its connection string, and set **`DATABASE_URL`** in your hosting provider’s **Environment Variables** (e.g. Vercel → Project → Settings → Environment Variables). Keep local `.env` for dev and use the host’s env for production.

### Verify the connection

From the project root (once Node and `pg` are set up):

```bash
node -e "require('pg').Pool({ connectionString: process.env.DATABASE_URL }).connect().then(c => { console.log('OK'); c.release(); process.exit(0); }).catch(e => { console.error(e); process.exit(1); })"
```

Or run your app and hit an API route that uses the DB; a successful response means the credentials work.

### Power BI returns 500 "An error has occurred" (Get Report or GenerateToken)

This usually means the Power BI tenant has not allowed Service Principals. Follow **[docs/POWERBI-SERVICE-PRINCIPAL-SETUP.md](docs/POWERBI-SERVICE-PRINCIPAL-SETUP.md)**:

1. Create an Azure AD security group and add your app (Service Principal) as a member.
2. In Power BI Admin Portal → Tenant settings → **Allow service principals to use Power BI APIs** → Enabled for that security group.
3. Add the Service Principal to the workspace (Access → add the app as Admin/Member) and use a **V2 (new) workspace**.

Test: `GET /api/test/azure` (Azure token) and `GET /api/test/powerbi` (report + embed token). The latter returns a `checklist` in the JSON when step is `report` and status is 500.

---

## 7. Database (PostgreSQL) — Lookup Model

Used for **user-to-report** and **user-to-role** mapping (Phase 2).

- **Users:** Either your existing app users or a minimal `users` table (id, email, name, etc.).
- **Reports:** Store at least `report_id` (Power BI report GUID), `workspace_id`, optional `display_name`.
- **User–Report–Role:** Map which user can see which report and with which RLS role(s) (e.g. `user_id`, `report_id`, `role_name`). One row per user-report-role combination if a user can have multiple roles per report.

Example (conceptual):

- `users` — id, email, ...
- `powerbi_reports` — id, report_id (GUID), workspace_id, name
- `user_report_roles` — user_id, report_id, role_name

Use migrations (Prisma/Drizzle/raw SQL) to create and evolve tables. Use a **single connection pool** in the app and reuse it across API routes.

---

## 8. Client Prerequisites (Before Dev)

- Azure subscription (for Power BI Embedded capacity).
- Power BI Pro license for the “master” account that publishes reports.
- A simple sample .pbix report for testing connectivity and RLS.

---

## 9. Recurring Costs (Client-Facing)

- **Power BI Embedded (A1):** ~\$735/month (hourly, can be paused).
- **Power BI Pro:** ~\$14/month (one license).
- **ArcGIS for Power BI:** Variable; client maintains with Esri.

---

## 10. Estimated Timeline

**Total: 6 weeks** — Phase 1 (1) → Phases 2 & 3 (4) → Phase 4 (1).

---

## 11. Useful Links

- [Power BI Embedded — Embed for your customers (App Owns Data)](https://learn.microsoft.com/en-us/power-bi/developer/embedded/embed-sample-for-customers)
- [Power BI REST API — Embed Token](https://learn.microsoft.com/en-us/rest/api/power-bi/embed-token)
- [powerbi-client-react (npm)](https://www.npmjs.com/package/powerbi-client-react)
- [Embed with RLS](https://learn.microsoft.com/en-us/power-bi/developer/embedded/cloud-rls)
- [PostgreSQL with Next.js (connection pooling)](https://node-postgres.com/) — use `pg` with a shared `Pool`.

---

## 12. Local Setup (After Env and DB Are Ready)

```bash
# Install dependencies
npm install

# Copy env and configure (Azure, Neon DATABASE_URL in .env)
cp .env.example .env

# Generate Prisma client and run migrations (Neon/PostgreSQL)
npx prisma generate
npx prisma migrate dev --name init

# Run dev server
npm run dev
```

Then open **http://localhost:3000/api/reports/seed** once to create a demo user and placeholder report. After that, **http://localhost:3000/reports** will list reports (mock user from env). See **[docs/TODO.md](docs/TODO.md)** for the SOW checklist and **[docs/PROJECT-STRUCTURE.md](docs/PROJECT-STRUCTURE.md)** for what `public/.gitkeep` is.

---

*Statement of Work: Power BI Embedded Portal Integration — AB&BCRE / Klizo Solutions.*
